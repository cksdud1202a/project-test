# 1. Helm 바이너리 설치 (이미 sudo 권한이 필요할 수 있으나, 보통 스크립트 내부에서 처리됨)
- name: Install Helm via script
  shell: |
    curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    chmod 700 get_helm.sh
    ./get_helm.sh
  args:
    creates: /usr/local/bin/helm
  become: true # /usr/local/bin에 파일을 써야 하므로 권한 필요

# 2. Prometheus 커뮤니티 Helm 레포지토리 추가
- name: Add Prometheus community repo
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: "https://prometheus-community.github.io/helm-charts"
  become: true # Helm 설정 및 k3s.yaml 접근을 위해 추가

# 3. 모니터링 네임스페이스 생성
- name: Create monitoring namespace
  kubernetes.core.k8s:
    name: "{{ monitoring_namespace }}"
    kind: Namespace
    state: present
    kubeconfig: "/etc/rancher/k3s/k3s.yaml" # 경로 명시 권장
  become: true # k3s.yaml을 읽기 위해 반드시 필요

# 4. 통합 배포 (외부 파일 로드 + 실시간 IP 주입)
- name: Deploy kube-prometheus-stack
  kubernetes.core.helm:
    name: "prometheus-stack"
    chart_ref: "prometheus-community/kube-prometheus-stack"
    chart_version: "{{ prometheus_chart_version }}"
    release_namespace: "{{ monitoring_namespace }}"
    kubeconfig: "/etc/rancher/k3s/k3s.yaml"
    binary_path: /usr/local/bin/helm
    values_files:
      - "{{ role_path }}/files/custom-values.yaml"
    values:
      grafana:
        service:
          type: NodePort
          nodePort: 32000
        grafana.ini:
          server:
            root_url: "http://{{ ansible_host }}:32000"
    wait: true
  become: true # k3s.yaml 파일 읽기 권한 획득
