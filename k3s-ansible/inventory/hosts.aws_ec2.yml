plugin: aws_ec2
regions:
  - ap-northeast-2

# 1. 대상 필터링: 프로젝트 이름이 일치하고 '실행 중'인 인스턴스만 수집
filters:
  tag:Project: "k3s-project"
  instance-state-name: [ 'running' ]

# 2. 그룹화: Role 태그 값에 따라 'server' 그룹과 'agent' 그룹으로 자동 분류
keyed_groups:
  - key: tags.Role
    separator: ""

# 3. 호스트 식별자: Ansible 내부에서 Private IP를 이름으로 사용
hostnames:
  - private-ip-address

# 4. 접속 변수 자동 조립 (가장 중요)
compose:
  # 모든 노드에 접속할 기본 사용자 설정
  ansible_user: "'ubuntu'"

  # 서버는 Public IP로, 에이전트는 Private IP로 접속 시도
  ansible_host: public_ip_address if (tags.Role == 'server') else private_ip_address

  ansible_ssh_common_args: >
    if (tags.Role == 'agent') then
      "-o ProxyCommand='ssh -W %h:%p -q ubuntu@{{ tags.ServerPublicIP }} -o StrictHostKeyChecking=no' -o ForwardAgent=yes"
    else
      ""
    endif
