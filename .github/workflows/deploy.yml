name: Provision & Configure K3s

on:
  push:
    branches: [ "master" ]  # 본인의 메인 브랜치명 확인
  workflow_dispatch:      # 수동 실행 가능

jobs:
  # -------------------------------------------------------------------
  # 1) Terraform Job: 인프라 생성 (IP 추출 단계 삭제)
  # -------------------------------------------------------------------
  terraform:
    name: Provision Infrastructure
    runs-on: [ self-hosted, Linux, X64 ]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

  # -------------------------------------------------------------------
  # 2) Ansible Job: 동적 인벤토리를 이용한 클러스터 구성
  # -------------------------------------------------------------------
  ansible:
    name: Configure K3s cluster & Deploy App
    runs-on: [ self-hosted, Linux, X64 ]
    needs: terraform
    env:
      # Ansible이 AWS API를 호출하여 노드를 찾기 위해 필요한 인증 정보
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      ANSIBLE_HOST_KEY_CHECKING: "False"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # pip3 설치 및 boto3 라이브러리 설치 (가장 중요)
      - name: Install Python and AWS dependencies
        run: |
          # pip3가 없는 경우 설치
          sudo apt-get update
          sudo apt-get install -y python3-pip
          # Ansible이 사용하는 Python 환경에 boto3 설치
          python3 -m pip install boto3 botocore

      # [추가] jq 설치 (API 파싱용)
      - name: Install jq
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get install -y jq
          else
            echo "jq is already installed: $(jq --version)"
          fi

      # 1. SSH 키 설정 (인증용 키 파일만 생성)
      - name: Setup SSH private key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

# --- [추가되는 부분] 동적 인벤토리 디버그 로그 ---
      - name: Debug Inventory (Show All Instances & Tags)
        working-directory: k3s-ansible
        run: |
          echo "1️⃣ [파일 구조 확인] 현재 폴더에 무엇이 있나요?"
          ls -R
          
          echo "2️⃣ [의존성 확인] boto3가 Ansible용 Python에 설치되었나요?"
          python3 -c "import boto3; print('boto3 version:', boto3.__version__)"
          
          echo "3️⃣ [Ansible 설정 확인] aws_ec2 플러그인이 활성화되어 있나요?"
          # ansible.cfg 파일이 있다면 내용을 출력해서 확인합니다.
          if [ -f "ansible.cfg" ]; then
            cat ansible.cfg
          else
            echo "ansible.cfg 파일이 없습니다. 기본 설정을 사용합니다."
          fi

          echo "4️⃣ [인벤토리 상세 분석] 왜 파싱에 실패하는지 로그를 끝까지 파헤칩니다."
          # -vvvv는 가장 상세한 로그를 보여줍니다.
          ansible-inventory -i aws_ec2.yml --graph -vvvv
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

      # 2. 전체 자동 배포 스크립트 실행
      - name: Run Deployment Script
        working-directory: k3s-ansible
        run: |
          chmod +x deploy.sh
          ./deploy.sh
