name: Provision & Configure K3s

on:
  push:
    branches: [ "master" ]  # ë³¸ì¸ì˜ ë©”ì¸ ë¸Œëœì¹˜ëª… í™•ì¸
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  # -------------------------------------------------------------------
  # 1) Terraform Job: ì¸í”„ë¼ ìƒì„± (IP ì¶”ì¶œ ë‹¨ê³„ ì‚­ì œ)
  # -------------------------------------------------------------------
  terraform:
    name: Provision Infrastructure
    runs-on: [ self-hosted, Linux, X64 ]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

  # -------------------------------------------------------------------
  # 2) Ansible Job: ë™ì  ì¸ë²¤í† ë¦¬ë¥¼ ì´ìš©í•œ í´ëŸ¬ìŠ¤í„° êµ¬ì„±
  # -------------------------------------------------------------------
  ansible:
    name: Configure K3s cluster & Deploy App
    runs-on: [ self-hosted, Linux, X64 ]
    needs: terraform
    env:
      # Ansibleì´ AWS APIë¥¼ í˜¸ì¶œí•˜ì—¬ ë…¸ë“œë¥¼ ì°¾ê¸° ìœ„í•´ í•„ìš”í•œ ì¸ì¦ ì •ë³´
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      ANSIBLE_HOST_KEY_CHECKING: "False"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # pip3 ì„¤ì¹˜ ë° boto3 ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (ê°€ì¥ ì¤‘ìš”)
      - name: Install Python and AWS dependencies
        run: |
          # pip3ê°€ ì—†ëŠ” ê²½ìš° ì„¤ì¹˜
          sudo apt-get update
          sudo apt-get install -y python3-pip
          # Ansibleì´ ì‚¬ìš©í•˜ëŠ” Python í™˜ê²½ì— boto3 ì„¤ì¹˜
          python3 -m pip install boto3 botocore

      # [ì¶”ê°€] jq ì„¤ì¹˜ (API íŒŒì‹±ìš©)
      - name: Install jq
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get install -y jq
          else
            echo "jq is already installed: $(jq --version)"
          fi

      # 1. SSH í‚¤ ì„¤ì • (ì¸ì¦ìš© í‚¤ íŒŒì¼ë§Œ ìƒì„±)
      - name: Setup SSH private key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

# --- [ì¶”ê°€ë˜ëŠ” ë¶€ë¶„] ë™ì  ì¸ë²¤í† ë¦¬ ë””ë²„ê·¸ ë¡œê·¸ ---
      - name: Debug Inventory (Show All Instances & Tags)
        working-directory: k3s-ansible
        run: |
          echo "ğŸ” í˜„ì¬ AWSì—ì„œ ìˆ˜ì§‘ëœ ì¸ë²¤í† ë¦¬ ëª©ë¡ì„ í™•ì¸í•©ë‹ˆë‹¤..."
          # íŠ¸ë¦¬ í˜•íƒœë¡œ ê·¸ë£¹ í™•ì¸
          ansible-inventory -i aws_ec2.yml --graph
          # ìƒì„¸ ë°ì´í„° í™•ì¸ (íƒœê·¸ ë° ë³€ìˆ˜ ì£¼ì… ìƒíƒœ)
          ansible-inventory -i aws_ec2.yml --list
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

      # 2. ì „ì²´ ìë™ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Run Deployment Script
        working-directory: k3s-ansible
        run: |
          chmod +x deploy.sh
          ./deploy.sh
