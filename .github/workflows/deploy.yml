name: Provision & Configure K3s

on:
  push:
    branches: [ "master" ]  # ë³¸ì¸ì˜ ë©”ì¸ ë¸Œëœì¹˜ëª… í™•ì¸
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  # -------------------------------------------------------------------
  # 1) Terraform Job: ì¸í”„ë¼ ìƒì„± (IP ì¶”ì¶œ ë‹¨ê³„ ì‚­ì œ)
  # -------------------------------------------------------------------
  terraform:
    name: Provision Infrastructure
    runs-on: [ self-hosted, Linux, X64 ]
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

  # ------------------------------------------------------------------
  # 2) Ansible Job: ë™ì  ì¸ë²¤í† ë¦¬ë¥¼ ì´ìš©í•œ í´ëŸ¬ìŠ¤í„° êµ¬ì„±
  # ------------------------------------------------------------------
  ansible:
    name: Configure K3s cluster & Deploy App
    runs-on: [ self-hosted, Linux, X64 ]
    needs: terraform
    env:
      # Ansibleì´ AWS APIë¥¼ í˜¸ì¶œí•˜ì—¬ ë…¸ë“œë¥¼ ì°¾ê¸° ìœ„í•´ í•„ìš”í•œ ì¸ì¦ ì •ë³´
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      ANSIBLE_HOST_KEY_CHECKING: "False"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # pip3 ì„¤ì¹˜ ë° boto3 ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (ê°€ì¥ ì¤‘ìš”)
      - name: Install Python and AWS dependencies
        run: |
          # pip3ê°€ ì—†ëŠ” ê²½ìš° ì„¤ì¹˜
          sudo apt-get update
          sudo apt-get install -y python3-pip
          # Ansibleì´ ì‚¬ìš©í•˜ëŠ” Python í™˜ê²½ì— boto3 ì„¤ì¹˜
          python3 -m pip install boto3 botocore
          # Ansibleì´ K8s/Helm ëª…ë ¹ì„ ë‚´ë¦¬ê¸° ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
          python3 -m pip install kubernetes PyYAML 
          # K8s ê´€ë ¨ ì „ìš© ëª¨ë“ˆ(Collection) ì„¤ì¹˜
          ansible-galaxy collection install kubernetes.core

      # [ì¶”ê°€] jq ì„¤ì¹˜ (API íŒŒì‹±ìš©)
      - name: Install jq
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get install -y jq
          else
            echo "jq is already installed: $(jq --version)"
          fi

      # 1. SSH í‚¤ ì„¤ì • (ì¸ì¦ìš© í‚¤ íŒŒì¼ë§Œ ìƒì„±)
      - name: Setup SSH private key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

# --- [ì¶”ê°€ë˜ëŠ” ë¶€ë¶„] ë™ì  ì¸ë²¤í† ë¦¬ ë””ë²„ê·¸ ë¡œê·¸ ---
      # 2. ì „ì²´ ìë™ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: ğŸ”¬ Ultimate Forensic Debugging
        working-directory: k3s-ansible
        run: |
          echo "========================================================="
          echo "ğŸ” 1. íŒŒì´ì¬ í™˜ê²½ì˜ 'ì§„ì‹¤' (Path & Version)"
          echo "========================================================="
          which python3
          python3 --version
          python3 -c "import sys; print('Python Path:', sys.path)"
          
          echo "========================================================="
          echo "ğŸ” 2. Boto3 ë¡œë“œ ê°€ëŠ¥ ì—¬ë¶€ ì§ì ‘ ê²€ì¦ (ìˆ˜ë™ í…ŒìŠ¤íŠ¸)"
          echo "========================================================="
          # ì´ ì½”ë“œê°€ ì‹¤íŒ¨í•˜ë©´ ì•¤ì„œë¸”ë„ ì ˆëŒ€ ëª» ì½ìŠµë‹ˆë‹¤.
          python3 -m pip list | grep -E "boto3|botocore|ansible"
          python3 -c "
          try:
              import boto3
              import botocore
              print('âœ… Boto3 Load Success!')
              print('Location:', boto3.__file__)
          except ImportError as e:
              print(f'âŒ Boto3 Load Failed: {e}')
          "

          echo "========================================================="
          echo "ğŸ” 3. Ansible Plugin ë¡œë” ì¶”ì "
          echo "========================================================="
          # ì•¤ì„œë¸”ì´ í”ŒëŸ¬ê·¸ì¸ì„ ì°¾ì„ ë•Œ ë’¤ì ¸ë³´ëŠ” ê²½ë¡œë“¤
          ansible-config dump | grep -E "COLLECTIONS_PATHS|DEFAULT_ROLES_PATH"
          # í˜„ì¬ ì‹œìŠ¤í…œì— 'amazon.aws' ì»¬ë ‰ì…˜ì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          ansible-galaxy collection list | grep amazon.aws || echo "âŒ Amazon AWS Collection missing!"

          echo "========================================================="
          echo "ğŸ” 4. ì¸ë²¤í† ë¦¬ íŒŒì‹± ì›ì‹œ ë¡œê·¸ (Traceback ëª¨ë“œ)"
          echo "========================================================="
          # ANSIBLE_DEBUG=1ì€ ì•¤ì„œë¸” ì†ŒìŠ¤ì½”ë“œ ë‚´ë¶€ì˜ ì—ëŸ¬ Tracebackì„ ê·¸ëŒ€ë¡œ ë±‰ì–´ëƒ…ë‹ˆë‹¤.
          # ê°€ì¥ ì§€ì €ë¶„í•˜ì§€ë§Œ ê°€ì¥ ì •í™•í•œ 'ë²”ì¸'ì˜ ì´ë¦„ì´ ì°í™ë‹ˆë‹¤.
          #export ANSIBLE_DEBUG=1
          #export ANSIBLE_VERBOSITY=4
          export ANSIBLE_INVENTORY_ENABLED=aws_ec2,yaml,ini
          ansible-inventory -i inventory/hosts.aws_ec2.yml --list
          echo "========================================================="
          echo "ğŸš€ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (deploy.sh)"
          echo "========================================================="
          chmod +x deploy.sh
          export PYTHONPATH=$PYTHONPATH:$(python3 -m site --user-site)
          ./deploy.sh
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          # ê²½ë¡œ ê°•ì œ ì£¼ì…
          PYTHONPATH: ${{ env.PYTHONPATH }}:$(python3 -m site --user-site)
          
